# ğŸ¦ Lean SDK Integration - Complete Implementation

A modern web application demonstrating **complete integration** of the Lean Web SDK for connecting to financial institutions in Saudi Arabia. This project includes a backend server, beautiful UI, and proper implementation following Lean's official documentation.

## âœ¨ Features

- âœ… **Complete Backend API Integration** - Real Lean API calls via Node.js server
- âœ… **Three-Step Authentication Flow** - API Token â†’ Create Customer â†’ Customer Token
- âœ… **Modern, Animated UI** - Colorful gradients, smooth animations, and friendly design
- âœ… **Sandbox Mode** - Safe testing without real bank connections
- âœ… **Real-time Results Display** - Shows all API responses and connection status
- âœ… **Comprehensive Error Handling** - Helpful error messages and troubleshooting
- âœ… **Debug Mode** - Detailed console logging for development
- âœ… **Success/Failure Pages** - Beautiful redirect pages with animations

## ğŸ¯ How It Works

### Lean's Two-Token System

This integration uses **TWO different tokens**:

1. **app_token** (Client ID)
   - Purpose: Identifies your application to Lean
   - Source: Fetched from backend `/api/config` endpoint
   - Used in: `Lean.connect()` method
   - Configured in: `.env` file on the server

2. **access_token** (Customer JWT)
   - Format: `eyJraWQiOiJiMGFiY2JmYy...` (long JWT token)
   - Purpose: Identifies the end user (customer)
   - Source: Generated by backend via Lean API
   - Used in: `Lean.connect()` method

### Three-Step Backend Flow

**Step 1: Get API Access Token**
```bash
POST https://sandbox.sa.leantech.me/oauth2/token
Body: {
  grant_type: "client_credentials",
  scope: "api"
}
```
Returns: API access token for making Lean API calls

**Step 2: Create Customer**
```bash
POST https://sandbox.sa.leantech.me/customers/v1
Headers: {
  Authorization: "Bearer {api_access_token}"
}
Body: {
  app_user_id: "user_random123"
}
```
Returns: `customer_id` (UUID)

**Step 3: Get Customer Access Token**
```bash
POST https://sandbox.sa.leantech.me/oauth2/token
Body: {
  grant_type: "client_credentials",
  scope: "customer.{customer_id}"
}
```
Returns: Customer access token (JWT) with 30-day expiration

## ğŸš€ Getting Started

### Prerequisites

- **Node.js** (v14 or higher)
- **npm** (comes with Node.js)
- A modern web browser

### Installation & Setup

1. **Navigate to the project directory**
   ```bash
   cd "Test SDK Lean"
   ```

2. **Install dependencies** (Optional - no external dependencies required)
   ```bash
   npm install
   ```

3. **Configure environment variables**
   ```bash
   cp .env.example .env
   ```
   Then edit `.env` and add your Lean API credentials:
   - `LEAN_CLIENT_ID` - Your Lean client ID
   - `LEAN_CLIENT_SECRET` - Your Lean client secret (keep this secret!)

4. **Start the server**
   ```bash
   node server.js
   ```

   You should see:
   ```
   ================================
   ğŸš€ Lean SDK Test Server Running
   ================================
   ğŸ“ URL: http://localhost:8000
   ğŸ”§ Environment: Sandbox
   âœ… Ready to accept requests!
   ```

4. **Open in browser**
   ```
   http://localhost:8000
   ```

## ğŸ® How to Use

### Step 1: Initialize Customer

1. Click the **"Initialize Customer"** button
2. Wait for the backend to complete the 3-step flow:
   - âœ… Get API Access Token
   - âœ… Create Customer in Lean
   - âœ… Get Customer Access Token
3. You'll see the **Customer ID** and confirmation message
4. The **"Connect with Lean"** button will be enabled

### Step 2: Connect Bank Account

1. Select **Account Type**: Personal or Business
2. Keep **Sandbox Mode** enabled for testing
3. Click **"Connect with Lean"**
4. The Lean SDK popup will open
5. Select a test bank (e.g., "Lean Bank")
6. Use test credentials:
   - Username: Any value
   - Password: Any value
7. Grant permissions
8. You'll be redirected to the success page!

### Step 3: View Results

- **Success**: Beautiful animated success page with checkmarks
- **Failure**: Helpful error page with reasons and retry option
- **Main Page**: Shows full API responses and connection details

## ğŸ“ Project Structure

```
Test SDK Lean/
â”‚
â”œâ”€â”€ server.js              # Backend Node.js server (handles all Lean API calls)
â”œâ”€â”€ index.html             # Main UI with two-step flow
â”œâ”€â”€ app.js                 # Frontend JavaScript (SDK integration)
â”œâ”€â”€ styles.css             # Modern, colorful styling with animations
â”œâ”€â”€ lean-success.html      # Success redirect page
â”œâ”€â”€ lean-failed.html       # Failure redirect page
â”œâ”€â”€ package.json           # Node.js dependencies
â””â”€â”€ README.md              # This file
```

## ğŸ”§ Technical Details

### Lean.connect() Implementation

The SDK is initialized using the **direct connect method**:

```javascript
// Frontend fetches app_token from backend first
const config = await fetch('http://localhost:8000/api/config');
const { client_id } = await config.json();

Lean.connect({
    app_token: client_id,                        // Fetched from backend
    permissions: [
        "identity",
        "accounts",
        "balance",
        "transactions",
        "identities",
        "scheduled_payments",
        "standing_orders",
        "direct_debits",
        "beneficiaries"
    ],
    customer_id: currentCustomerId,              // From backend API
    sandbox: true,                               // Enable sandbox
    access_token: currentAccessToken,            // JWT from backend
    fail_redirect_url: 'http://localhost:8000/lean-failed.html',
    success_redirect_url: 'http://localhost:8000/lean-success.html',
    account_type: 'personal'                     // or 'business'
});
```

### Backend API Endpoints

**POST /api/initialize-customer**

Initializes a new customer with Lean and returns access token.

Request:
```json
{
  "app_user_id": "user_random123"
}
```

Response:
```json
{
  "success": true,
  "customer_id": "82e518a0-19fe-4561-ae2a-988b5056d5af",
  "access_token": "eyJraWQiOiJiMGFiY2JmYy...",
  "app_user_id": "user_random123",
  "token_expires_in": 2592000,
  "token_scope": "customer.82e518a0-19fe-4561-ae2a-988b5056d5af"
}
```

## ğŸ¨ UI Features

- **Modern Gradients**: Purple to pink gradient background
- **Smooth Animations**: Fade in, slide in, bounce effects
- **Glassmorphism**: Backdrop blur effects on cards
- **Gradient Text**: Beautiful gradient headings
- **Button Animations**: Hover effects with smooth transitions
- **Status Badges**: Animated success/error badges
- **Responsive Design**: Works on desktop, tablet, and mobile

## ğŸ” Debug Mode

Enable **Debug Mode** checkbox to see:
- Detailed console logs with timestamps
- SDK method calls and parameters
- API responses
- Connection configuration
- Error stack traces

## ğŸ› Troubleshooting

### Server Won't Start

**Issue**: Port 8000 already in use

**Solution**:
```bash
# Find process using port 8000
lsof -ti:8000

# Kill the process
lsof -ti:8000 | xargs kill

# Start server again
node server.js
```

### SDK Popup Not Opening

**Issue**: Lean.connect() called but no popup

**Solutions**:
1. Check browser console for errors
2. Ensure Lean SDK loaded (check for script errors)
3. Verify customer was initialized first
4. Make sure popup blockers are disabled
5. Enable Debug Mode for detailed logs

### Customer Initialization Failed

**Issue**: Backend API calls failing

**Solutions**:
1. Check server is running (`node server.js`)
2. Verify internet connection (APIs are external)
3. Check server.js has correct credentials
4. Look at server console for error details
5. Ensure `node-fetch@2` is installed

### CORS Errors

**Why we have a backend**: Browser cannot directly call Lean APIs due to CORS restrictions. The Node.js server acts as a proxy.

### Connection Cancelled

**Issue**: User sees failure page

**Reasons**:
- User clicked "Cancel" in Lean popup
- Session timeout (took too long)
- Invalid credentials in sandbox
- Bank service unavailable

**Solution**: Click "Try Again" and complete the flow

## ğŸ“Š API Credentials

All credentials are stored securely in environment variables:

1. **Copy the example environment file:**
   ```bash
   cp .env.example .env
   ```

2. **Edit `.env` and add your Lean API credentials:**
   ```bash
   LEAN_CLIENT_ID=your_client_id_here
   LEAN_CLIENT_SECRET=your_client_secret_here
   ```

3. **Never commit the `.env` file to Git** - it's already in `.gitignore`

These are **sandbox credentials** - safe for testing, no real banking connections.

## ğŸ”’ Security Notes

- âœ… **Client Secret** stored in backend (not exposed to browser)
- âœ… **Customer tokens** generated server-side
- âœ… **Sandbox mode** prevents real bank connections
- âš ï¸ **Client ID** exposed in frontend (acceptable for this SDK use case)
- âš ï¸ **For production**: Use environment variables, not hardcoded values

## ğŸ“š Documentation & Resources

- **Lean Web SDK Docs**: https://docs.leantech.me/v2.0-KSA/docs/web
- **Lean API Reference**: https://docs.leantech.me
- **Developer Portal**: https://dev.sa.leantech.me
- **Lean Tech Website**: https://leantech.me

## âœ… What's Working

- âœ… Backend server running on port 8000
- âœ… Three-step API flow (API Token â†’ Customer â†’ Customer Token)
- âœ… Customer initialization with unique IDs
- âœ… Lean.connect() with correct configuration
- âœ… SDK popup for bank selection
- âœ… Success/failure redirect pages
- âœ… Beautiful, modern UI with animations
- âœ… Debug mode and error handling

## ğŸ¬ Quick Test

1. **Start Server**: `node server.js`
2. **Open Browser**: http://localhost:8000
3. **Click**: "Initialize Customer"
4. **Wait**: See customer ID appear
5. **Click**: "Connect with Lean"
6. **Select**: Any test bank
7. **Login**: Use any credentials
8. **Success**: Redirected to success page! ğŸ‰

## ğŸš¦ Server Status

The server logs all operations:

```
âœ… API Access Token obtained
âœ… Customer created: 1632864b-a309-4223-9659-cc9c746b0910
âœ… Customer Access Token obtained
âœ… Initialization Complete!
```

Multiple customers can be created - each gets a unique ID.

## ğŸ’¡ Next Steps

After testing:

1. **Store Customer Data**: Save customer_id and access_token in your database
2. **Use Lean APIs**: Fetch accounts, balances, transactions using the access token
3. **Webhook Integration**: Set up webhooks for account updates
4. **Production Mode**: Switch to production credentials and URLs
5. **Token Refresh**: Implement token refresh before 30-day expiration

## ğŸ“ License

This is a demonstration project for educational purposes.

## ğŸ¤ Support

For issues with:
- **This Implementation**: Check troubleshooting section above
- **Lean SDK**: Contact Lean Tech support
- **Lean APIs**: Visit Lean documentation

---

**Built with â¤ï¸ using [Lean Web SDK](https://docs.leantech.me/v2.0-KSA/docs/web)**

*Last Updated: Latest implementation with complete backend integration*
